service: s3-elasticache-sync

provider:
  name: aws
  runtime: nodejs18.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'prod'}
  
  environment:
    REDIS_ENDPOINT: ${env:REDIS_ENDPOINT}
    REDIS_PORT: ${env:REDIS_PORT, '6379'}
  
  vpc:
    securityGroupIds:
      - ${env:SECURITY_GROUP_ID}
    subnetIds:
      - ${env:SUBNET_ID_1}
      - ${env:SUBNET_ID_2}
  
  iamRoleStatements:
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
      Resource: "arn:aws:logs:*:*:*"
    
    - Effect: Allow
      Action:
        - s3:GetObject
        - s3:ListBucket
        - s3:GetBucketLocation
        - s3:ListBucketVersions
      Resource:
        - "arn:aws:s3:::mus86077"
        - "arn:aws:s3:::mus86077/*"
    
    - Effect: Allow
      Action:
        - ec2:CreateNetworkInterface
        - ec2:DescribeNetworkInterfaces
        - ec2:DeleteNetworkInterface
        - ec2:AssignPrivateIpAddresses
        - ec2:UnassignPrivateIpAddresses
      Resource: "*"
    
    - Effect: Allow
      Action:
        - elasticache:Describe*
      Resource: "*"

functions:
  s3ElasticacheSync:
    handler: index.handler
    name: ${self:service}-${self:provider.stage}
    description: Syncs S3 bucket file list to ElastiCache on file changes
    memorySize: 512
    timeout: 60
    events:
      - s3:
          bucket: mus86077
          event: s3:ObjectCreated:*
          existing: true
      - s3:
          bucket: mus86077
          event: s3:ObjectRemoved:*
          existing: true

package:
  exclude:
    - .git/**
    - .gitignore
    - README.md
    - deploy.ps1
    - deploy.bat
    - lambda-policy.json
    - lambda-execution-policy.json